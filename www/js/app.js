/*
 * Please see the included README.md file for license terms and conditions.
 */
/** @file app.js
 *	Purpose:  contains all of the javascript for the index file
 *
 * @author Keith Gudger
 * @copyright  (c) 2016, Keith Gudger, all rights reserved
 * @license    http://opensource.org/licenses/BSD-2-Clause
 * @version    Release: 1.0
 * @package    CoastalWatershedCouncil
 *
 */
	var currentLatitude = 0;
	var currentLongitude = 0;
	var options = {			// Intel GPS options
        timeout: 10000,
        maximumAge: 20000,
        enableHighAccuracy: true
	};

// The function below is an example of the best way to "start" your app.
// This example is calling the standard Cordova "hide splashscreen" function.
// You can add other code to it or add additional functions that are triggered
// by the same event or other events.

function onAppReady() {
    queryString = "command=getDate";
    sendfunc(queryString)
    ready();
}

document.addEventListener("app.Ready", onAppReady, false) ;

// The app.Ready event shown above is generated by the init-dev.js file; it
// unifies a variety of common "ready" events. See the init-dev.js file for
// more details. You can use a different event to start your app, instead of
// this event. A few examples are shown in the sample code above. If you are
// using Cordova plugins you need to either use this app.Ready event or the
// standard Crordova deviceready event. Others will either not work or will
// work poorly.

// NOTE: change "dev.LOG" in "init-dev.js" to "true" to enable some console.log
// messages that can help you debug Cordova app initialization issues.

/**
 *	Fires when DOM page loaded
 */
function ready() {
    if (navigator.geolocation) {
		var location_timeout = setTimeout("defaultPosition()", 10000);
		// changed to 2 seconds 
		console.log("In Ready");
        navigator.geolocation.getCurrentPosition(
			function(pos) { clearTimeout(location_timeout); showPosition(pos); },
			function(err) {
				clearTimeout(location_timeout);
				console.warn('ERROR(' + err.code + '): ' + err.message);
				defaultPosition()
			},
			options
		);
    }
    else {
		console.warn("Geolocation failed. \nPlease enable GPS in Settings.", 1);
		defaultPosition();
	}
 	$('#date-field').datepick({dateFormat: 'yyyy-mm-dd',
		onClose: function(dates) { setDate(dates); }
	});
	$('#arrive-field').timeEntry({spinnerImage: './images/spinnerDefault.png'});
/*	$('#collect-field').timeEntry({spinnerImage: './images/spinnerDefault.png'});
 	$('#date-field2').datepick({dateFormat: 'yyyy-mm-dd',
		onClose: function(dates) { setDate(dates); } 
	}); 
	$('#arrive-field2').timeEntry({spinnerImage: './images/spinnerDefault.png'});
	$('#depart-field2').timeEntry({spinnerImage: './images/spinnerDefault.png'});
	$('#rtime-field2').timeEntry({spinnerImage: './images/spinnerDefault.png'});*/
 	$('#date-field3').datepick({dateFormat: 'yyyy-mm-dd',
		onClose: function(dates) { setDate(dates); }
	});
	$('#arrive-field3').timeEntry({spinnerImage: './images/spinnerDefault.png'});
	$('#sample-field3').timeEntry({spinnerImage: './images/spinnerDefault.png'});

	$('#tcoll1_in').timeEntry({spinnerImage: './images/spinnerDefault.png'});
	$('#tcoll2_in').timeEntry({spinnerImage: './images/spinnerDefault.png'});
	$('#tcoll3_in').timeEntry({spinnerImage: './images/spinnerDefault.png'});
	
	setupDate();
}
	/**
	 * date setup
	 */
function setupDate() {
	var currentDate = new Date()
	var day = currentDate.getDate()
	var month = currentDate.getMonth() + 1
	if(day < 10) {
		day = '0' + day;
	} 
	if( month < 10 ) {
		month = '0' + month ;
	} 
	var year = currentDate.getFullYear()
	var ndate = year + '-' + month + '-' + day;
    var out = document.getElementById("datein");
    var dout = document.getElementById("date-field");
    out.value = dout.value = ndate ;
/*	out = document.getElementById("datein2");
    dout = document.getElementById("date-field2");
    out.value = dout.value = ndate ;*/
	out = document.getElementById("datein3");
    dout = document.getElementById("date-field3");
    out.value = dout.value = ndate ;
} // setupDate

	/**
	 *	set date function for date field
	 */
	function setDate(dates) {
        var out = document.getElementById("datein");
//        var out2 = document.getElementById("datein2");
        var out3 = document.getElementById("datein3");
		var selected = ''; 
		for (var i = 0; i < dates.length; i++) { 
			selected += ',' + $.datepick.formatDate('yyyy-mm-dd',dates[i]); 
		} 
//		alert('Selected dates are: ' + selected.substring(1)); 
        out.value = /*out2.value = */out3.value = selected.substring(1) ;
    }


/** 
 *	sets current latitude and longitude from ready() function
 */
function showPosition(position) {
	console.log('In showPosition');
	if ( position ) {
		currentLatitude = position.coords.latitude;
		currentLongitude = position.coords.longitude;
	}
	setupPosition();
};

/**
 * set up location position
 */
function setupPosition() {
    var latid = document.getElementById("latin");
    var lonid = document.getElementById("lonin");
    latid.value = currentLatitude;
    lonid.value = currentLongitude;
/*	latid = document.getElementById("latin2");
    lonid = document.getElementById("lonin2");
    latid.value = currentLatitude;
    lonid.value = currentLongitude;*/
	latid = document.getElementById("latin3");
    lonid = document.getElementById("lonin3");
    latid.value = currentLatitude;
    lonid.value = currentLongitude;
   console.log("Lat is " + latid.value + " Lon is " + lonid.value);	
}
/** 
 *	on fail from ready, default position
 */
function defaultPosition() {
	console.log('In defaultPosition');
	showPosition(null); 
//	alert("defaultPosition");
}


/**
	 *	onclick function for "minus" button
	 */
	function minus_one(elt) {
        var val = document.getElementById(elt);
        if (val.value > 0) val.value--;
    }

	/**
	 *	onclick function for "plus" button
	 */
	function plus_one(elt) {
        var val = document.getElementById(elt);
        val.value++;
    }

	/**
	 *	onblur function for date field
	 */
	function fillDate(elt) {
        var val = document.getElementById(elt).value;
        var out = document.getElementById("datein");
        out.value = val ;
        console.log("date is " + out.value);
    }
/**
 *	sendData function, called when submit clicked
 */
function sendData() {
    var out = document.getElementById("name-in").value;
    if ( out == "" ) {
        alert("Please enter your name before submitting, thanks.");
	} else if ( document.getElementById("name-in").value == "" )
	{
        alert("Please enter your name before submitting, thanks.");
	} else if ( document.getElementById("site-name").value == "" )
	{
        alert("Please enter the site name before submitting, thanks.");
	} else if ( document.getElementById("site-id").value == "" )
	{
        alert("Please enter the site id before submitting, thanks.");
	} else if ( document.getElementById("arrive-field").value == "" )
	{
        alert("Please enter the arrival time before submitting, thanks.");
	} else {
        var queryString = $('#fielddataform').serialize();
        queryString = "command=send&" + queryString;
        sendfunc(queryString);
//    alert(queryString);
        document.getElementById("fielddataform").reset()
        setupDate();
		setupPosition();
		var ele = document.getElementById('dataCard');
		window.scrollTo(ele.offsetLeft,ele.offsetTop);
   }
   console.log("Should switch now.");

}

/**
 *	"Ajax" function that sends and processes xmlhttp request
 *	@param params is GET request string
 */
function sendfunc(params) {
    var xmlhttp;
	try {
	   xmlhttp=new XMLHttpRequest();
    } catch(e) {
        xmlhttp = false;
        console.log(e);
    }
	if (xmlhttp) {
        xmlhttp.onreadystatechange=function()
		{
		  if (xmlhttp.readyState==4 && xmlhttp.status==200)
          {
              returnedList = (xmlhttp.responseText);
              console.log("Returned value is " + returnedList.search("Collector Entered"));
              if ( returnedList.search("Collector Entered") < 0 ) {
                  returnedList = JSON.parse(xmlhttp.responseText);
                  if (typeof (returnedList["Date"]) !== 'undefined') {
                    var val = document.getElementById("date-field");
                    var ndate = returnedList["results"];
                    if ( ndate != undefined && ndate != "0000-00-00") {
						val.value = returnedList["results"];
						val.disabled = true;
					}
                  }
              }
              else {
//				  	$( ":mobile-pagecontainer" ).pagecontainer( "change", "#summary", { role: "dialog" } );
					confirm("Thank you for your data submission!");
			  }
          }
	}
	xmlhttp.open("GET","http://home.loosescre.ws/~keith/CWC/server.php" + '?' + params, true);
//	xmlhttp.open("GET","http://www.saveourshores.org/server.php" + '?' + params, true);
	xmlhttp.send(null);
    }
}; // sendfunc

	/**
	 *	onclick function for web addresses
	 */
		function splashclick(url) {
//            alert("Typeof is " + typeof(intel));
            if (typeof (intel) === 'undefined') 
				window.open(url,'_system');
			else
				intel.xdk.device.launchExternal(url);
		};
// 37.0067 -121.97

/**
 *	photoCap function, called when Take Photo clicked
 */
function photoCap() {
	console.log('In photoCap Lat= '+currentLatitude + " Lon=" + currentLongitude);
//	alert("Taking Photo");
	if (butid = document.getElementById('saveButt')) 
		butid.parentNode.removeChild(butid);
	if(navigator.camera) {
		var canid  = document.getElementById('can_id');
		navigator.camera.getPicture(function(imageData){
			var canvas = document.getElementById('canvas');
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
//			style="width:auto;height:500px;"
//			canvas.style.width = "auto";
//			canvas.style.height = "500px";
//			canvas.style.height = "auto";
			var ctx = canvas.getContext('2d');
			var image = new Image();
			image.src = "data:image/jpeg;base64," + imageData;
//			image.src = imageData;
			image.onload = function(e) {
				ctx.drawImage(image,0,0, image.width, image.height,
									0,0, canvas.width, canvas.height);
				ctx.lineWidth=3;
				ctx.fillStyle="yellow";
//				ctx.lineStyle="#ffff00";
				ctx.font="15px sans-serif";
				var text = "Lat=" + currentLatitude ;
				ctx.strokeStyle = 'black';
				ctx.strokeText(text,10,15);
				ctx.fillText(text,10,15);
				text = "Lon=" + currentLongitude;
				ctx.strokeText(text,10,35);
				ctx.fillText(text,10,35);
				text = new Date() ;
				ctx.strokeText(text,10,55);
				ctx.fillText(text,10,55);
				var btn = document.createElement("button");
				btn.innerHTML = "Save Photo";
				btn.setAttribute("id", "saveButt");
				btn.className="blue_sub";
				btn.onclick = savePhoto;
				canid.appendChild(btn);
			}
//			console.log(imageData);
		}, null, {sourceType:Camera.PictureSourceType.CAMERA, quality: 50, 
//				targetWidth: 1500, targetHeight: 2048,
				correctOrientation: true,
				encodingType: Camera.EncodingType.JPEG,
				destinationType: Camera.DestinationType.DATA_URL});
	} else {
		alert("Camera not supported on this device.");
	}
}

function cameraError(message)
{
	alert ("Camera Operation Failed with error " + message);
}

/**
 *	savePhoto function, called when photo save button clicked
 */
function savePhoto()
{
	window.canvas2ImagePlugin.saveImageDataToLibrary(
        function(msg){
			alert("Saving Photo");
            console.log(msg);
			var canvas = document.getElementById('canvas');
//			style="width:auto;height:500px;"
			canvas.width = "0px";
			canvas.height = "0px";
			var ctx = canvas.getContext('2d');
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			var butid = document.getElementById('saveButt');
			butid.parentNode.removeChild(butid);
        },
        function(err){
            console.log(err);
        },
        document.getElementById('canvas')
    );
}
